<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DWEB Academic Papers example</title>
    <link rel='stylesheet' href='example_styles.css'>
    <script type="text/javascript" src="dweb_transport_ipfs_bundled.js"></script><!-- Dwebbundle via local filesystem when testing without Dweb-->
    <script type="text/javascript" src="htmlutils.js"></script><!--HTML tools (not specific to Dweb)-->
    <script type="text/javascript" src="objbrowser.js"></script><!--objectbrowser functionality for debugging-->
    <script type="text/javascript">
        
    function p_submit_searchbox() {
        //TODO-ACADEMIC handle contenthash format
        let dict = form2dict("searchbox");
        url = `https://gateway.dweb.me:443/metadata/${dict.namespace}/${dict.name}?verbose=1`;
        console.log("p_submit_searchbox: ---", dict, "fetching", url);
        //TODO-ACADEMIC switch to TransportHTTP, and merge this pattern into TransportHTTP or move to miscutils.js.httpget()
        p_httpget(url)
            .then((json) => display_metadata(json))
            .catch((err) => {
                console.log("Probably misleading error from fetch:", url, err);
                throw new Error(`Transport error thrown by ${url}`)
            });  // Error here is particularly unhelpful - if rejected during the COrs process it throws a TypeError
    }
    function display_metadata(j) {
        //TODO-ACADEMIC - add a way to view the JSON
        console.log("XXX@display_metadata",j);
        let authors = j.doi_org_metadata.author.map((a) => `${a.given} ${a.family}`).join(', ');
        replacetexts("metadata", j.doi_org_metadata, {authors: authors});  //TODO expand this
        deletechildren('list_of_files');
        j.files.map((f) => addtemplatedchild("list_of_files", f, {
            ipldurl: `https://ipfs.dweb.me:443/ipfs/${f.ipldhash}`,
            //ipldurl: `https://ipfs.io:443/ipfs/${f.ipldhash}`,
            multihash58url: `https://gateway.dweb.me:443/content/contenthash/${f.multihash58}`
        }));  // Adds one line per file: bytes, mimetype
        show("metadata");
    }

    </script>
</head>

<body class="examplesacademic">
<!--Online indicator--><div class="floatright"><div id="status">Starting</div></div>
<h1>Decentralized Web Academic Papers Example</h1>
<!--DOI name entry box-->
<div>
    <p>This is a demonstration gateway for Academic documents, a (centralized) search at Archive.org results in links to
    the file either via IPFS or through the Archive's content server.</p>
    <p>Hint: You can try with DOI: 10.1001/jama.2009.1064 or 10.1002/ajhb.20806</p>
</div>
<div class="displayedblock">
    <div class="displayedblockheader" id="doi_header">
        <form class="dialogform" name="searchbox" onsubmit="p_submit_searchbox(); return false;">
            <!--TODO autopopulate this from an info call-->
            <div class="tooltip">
                <span class="tooltiptext">You can select what kind of name you want to search.</span>
                <select name="namespace" ><!--TODO catch changes and change placeholder for text input--><!--TODO-OTHERNAMESPACE-->
                    <option value="doi">DOI</option>
                    <option value="contenthash">Content Hash</option>
                </select>
            </div>
            <div class="tooltip">
                <span class="tooltiptext">You can enter the name to search for here, e.g. 10.1002/ajhb.20806</span>
                <input type="text" name="name" size="50" placeholder="DOI of paper"/>
            </div>
            <input class="button" type="submit" value="SEARCH"/>
        </form>
    </div>
    <div class="displayedblock" style="display:none;" id="metadata">
        <span name="title" class="prop"></span>
        <span name="authors" class="prop"></span>
        <a href="META" class="prop">DOI metadata</a>
        <!-- TODO turn mimetype into icon like PDF -->
        <ul id="list_of_files" class="fileslist">
            <li class="template prop">
                <span name="mimetype" class="propval"></span>
                &nbsp;<span name="size_bytes" class="propval"></span>
                &nbsp;<span class="propval">bytes</span>
                <a href="ipldurl" class="propval tooltip">
                    <span class="tooltiptext">Fetch the file from an IPFS gateway</span>
                    <img src="ipfslogo.png" height="24px" alt="IPFS Logo"/>
                </a>
                <a href="multihash58url" class="propval tooltip">
                    <span class="tooltiptext">Fetch the file from the Archive's contenthash server</span>
                    <img src="archivelogowhiteonblack.png" height="24px" alt="Archive logo"/>
                </a>
            </li><!--use IPFS logo-->
        </ul>
    </div>

</div>
<script type="text/javascript">
    // This is the "main()", starts a transport, checks its status, and if appropriate to app opens a URL passed
    const searchparms = new URL(window.location.href).searchParams;
    /*TODO what parameters ?
    const url = searchparms.get("url");
    */
    var verbose = searchparms.get("verbose") || false;  // Anything specified for verbose is true (could truthify buy no need)
    /* Select transport - ?transport=HTTP to use HTTP*/
    // Add a function to htmlutils to simplify this.
    Dweb.TransportHTTP.p_setup({http: { ipandport:["gateway.dweb.me", 443]}}, verbose)
        .then((t) => t.p_status())
        .then((msg) => alert(msg))  //TODO-status as list
        .catch((err) => { console.log("ERROR in connecting to HTTP:",err); alert(err.message); });
    let transportclass = Dweb["Transport"+(searchparms.get("transport") || "HTTP").toUpperCase()]; // e.g. Dweb["TransportHTTP"]
    transportclass.p_setup({}, verbose)
        .then((t) => t.p_status())
        .then((msg) => setstatus(msg))
        .then(() => {
            // Any code you want to run once online goes here.
            //if(url) fetchanddisplay(url);  // In this app, ignoring any URL passed in call
        })
        .catch((err) => { console.log("ERROR connecting:",err); alert(err.message); });

</script>
</body>
</html>
