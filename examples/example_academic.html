<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DWEB Academic Papers example</title>
    <link rel='stylesheet' href='example_styles.css'>
    <script type="text/javascript" src="dweb_transport_ipfs_bundled.js"></script><!-- Dwebbundle via local filesystem when testing without Dweb-->
    <script type="text/javascript" src="htmlutils.js"></script><!--HTML tools (not specific to Dweb)-->
    <script type="text/javascript" src="objbrowser.js"></script><!--objectbrowser functionality for debugging-->
    <script type="text/javascript">

        function p_submit_searchbox() {
            //TODO-ACADEMIC handle contenthash format
            let dict = form2dict("searchbox");
            url = `https://gateway.dweb.me:443/metadata/${dict.namespace}/${dict.name}?verbose=1`;
            console.log("p_submit_searchbox: ---", dict, "fetching", url);
            //TODO-ACADEMIC switch to TransportHTTP, and merge this pattern into TransportHTTP or move to miscutils.js.httpget()
            p_httpget(url)
                .then((json) => display_metadata(json))
                .catch((err) => {
                    console.log("Probably misleading error from fetch:", url, err);
                    throw new Error(`Transport error thrown by ${url}`)
                });  // Error here is particularly unhelpful - if rejected during the COrs process it throws a TypeError
        }
        function display_metadata(j) {
            //TODO-ACADEMIC - add a way to view the JSON
            if (verbose) console.log("display_metadata",j);
            let authors = j.doi_org_metadata.author ? j.doi_org_metadata.author.map((a) => `${a.given} ${a.family}`).join(', ') : "Unable to retrieve author";
            replacetexts("metadata", j.doi_org_metadata, {authors: authors});  //TODO expand this
            deletechildren('list_of_files');
            j.files.map((f) => addtemplatedchild("list_of_files", f, {
                ipldurl: `https://ipfs.dweb.me:443/ipfs/${f.ipldhash}`,
                ipld2url: `https://ipfs.io:443/ipfs/${f.ipldhash}`,
                multihash58url: `https://gateway.dweb.me:443/content/contenthash/${f.multihash58}`
            }));  // Adds one line per file: bytes, mimetype
            show("metadata");
        }

        function display_ipfs(el) {
            //verbose = true;
            let multihash = el.getAttribute("href"); // Note this is not el.href which has the domain as well
            if (verbose) console.log("display_ipfs:", multihash);
            Dweb.Block.p_fetch(`ipfs:/ipfs/${multihash}`, verbose)
                .then((blk) => {
                    if (verbose) console.log("display_ipfs retrieved",blk._data.constructor.name, blk.size());
                    if (verbose && blk.size() < 1000) console.log("Buffer=", blk._data.toString());
                    display_blob(blk._data,{type: 'application/pdf'}); //TODO allow for multiple types
                })
                .catch((err) => {
                    console.log("display_ipfs cant retrieve",err)
                })


        }
    </script>
</head>

<body class="examplesacademic">
<!--Online indicator--><div class="floatright"><div id="status">Starting</div></div>
<div>
    <img src="dweb-gateway.jpg" height="100px" alt="Archive and IPFS logos" class="floatleft"/><h1>Decentralized Web Academic Papers Example</h1>
</div>
<!--DOI name entry box-->
<div>
    <p>This is a demonstration gateway for Academic documents, a (centralized) search at Archive.org results in links to
        the file either via IPFS or through the Archive's content server.</p>
    <p>Hint: You can try with DOI: 10.1001/jama.2009.1064 or 10.1002/ajhb.20806</p>
</div>
<div class="displayedblock">
    <div class="displayedblockheader" id="doi_header">
        <form class="dialogform" name="searchbox" onsubmit="p_submit_searchbox(); return false;">
            <!--TODO autopopulate this from an info call-->
            <div class="tooltip">
                <span class="tooltiptext">You can select what kind of name you want to search.</span>
                <select name="namespace" ><!--TODO catch changes and change placeholder for text input--><!--TODO-OTHERNAMESPACE-->
                    <option value="doi">DOI</option>
                    <option value="contenthash">Content Hash</option>
                    <option value="sha1hex">SHA1 Hex</option>
                </select>
            </div>
            <div class="tooltip">
                <span class="tooltiptext">You can enter the name to search for here, e.g. 10.1002/ajhb.20806</span>
                <input type="text" name="name" size="50" placeholder="DOI of paper"/>
            </div>
            <input class="button" type="submit" value="SEARCH"/>
        </form>
    </div>
    <div class="displayedblock" style="display:none;" id="metadata">
        <span name="title" class="prop"></span>
        <span name="authors" class="prop"></span>
        <!-- TODO turn mimetype into icon like PDF -->
        <ul id="list_of_files" class="fileslist">
            <li class="template academic_demo_file">
                <div class="academic_demo_meta">
                    <span name="mimetype"></span>
                    &nbsp;<span name="size_bytes"></span>
                    &nbsp;<span>bytes</span>
                </div>
                <a href="multihash58url" class="academic_demo_a" target="_blank">
                    <img src="archivelogowhiteonblack.png" height="24px" alt="Archive logo" class="academic_demo_img"/>
                    <div class="academic_demo_link">
                        <span class="academic_link">Fetch the file from the Archive's contenthash server</span><br/>
                        <span name="multihash58url"></span>
                    </div>
                </a>
                <a href="ipldurl" class="academic_demo_a" target="_blank">
                    <img src="ipfslogo.png" height="24px" alt="IPFS Logo" class="academic_demo_img"/>
                    <div class="academic_demo_link">
                        <span class="academic_link">Fetch the file from the Archive's IPFS gateway:</span><br/>
                        <span name="ipldurl"></span></div>
                </a>
                <a href="ipld2url" class="academic_demo_a" target="_blank">
                    <img src="ipfslogo.png" height="24px" alt="IPFS Logo" class="academic_demo_img"/>
                    <div class="academic_demo_link">
                        <span class="academic_link">Fetch the file from the main IPFS gateway</span><br/>
                        <span name="ipld2url"></span>
                    </div>
                </a>
                <a href="ipldhash" class="academic_demo_a" target="_blank" onclick="display_ipfs(this); return false;">
                    <img src="ipfslogo.png" class="academic_demo_img" height="24px" alt="IPFS Logo"/>
                    <div class="academic_demo_link">
                        <span class="academic_link">Fetch the file from IPFS directly in the browser</span><br/>
                        <span name="ipldhash"></span>
                    </div>
                </a>
            </li><!--template-->
        </ul>
    </div>

</div>
<script type="text/javascript">
    // This is the "main()", starts a transport, checks its status, and if appropriate to app opens a URL passed
    const searchparms = new URL(window.location.href).searchParams;
    /*TODO what parameters ?
    const url = searchparms.get("url");
    */
    var verbose = searchparms.get("verbose") || false;  // Anything specified for verbose is true (could truthify buy no need)
    /* Select transport - ?transport=HTTP to use HTTP*/
    // Add a function to htmlutils to simplify this.
    // Dweb.TransportIPFS.p_setup({http: { ipandport:["gateway.dweb.me", 443]}}, verbose)
    //    .then((t) => t.p_status())
    //    .then((msg) => alert(msg))  //TODO-status as list
    //    .catch((err) => { console.log("ERROR in connecting to HTTP:",err); alert(err.message); });
    let transportclass = Dweb["Transport"+(searchparms.get("transport") || "IPFS").toUpperCase()]; // e.g. Dweb["TransportHTTP"]
    transportclass.p_setup({}, verbose)
        .then((t) => t.p_status())
        .then((msg) => setstatus(msg))
        .then(() => {
            // Any code you want to run once online goes here.
            //if(url) fetchanddisplay(url);  // In this app, ignoring any URL passed in call
            //test_display_object();
        })
        .catch((err) => { console.log("ERROR connecting:",err); alert(err.message); });

</script>
</body>
</html>
