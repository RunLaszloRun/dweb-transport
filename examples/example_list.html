<!DOCTYPE html>
<!--suppress HtmlUnknownTarget -->
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>DWEB CommonList example</title>
    <link rel='stylesheet' href='example_styles.css'>
    <script type="text/javascript" src="dweb_transport_ipfs_bundled.js"></script><!-- Dwebbundle via local filesystem when testing without Dweb-->
    <script type="text/javascript" src="htmlutils.js"></script><!--HTML tools (not specific to Dweb)-->
    <script type="text/javascript" src="objbrowser.js"></script><!--objectbrowser functionality for debugging-->
    <script type="text/javascript">

    var cl; // Will hold the list after fetching
    //TODO-MULTI-needs-scanning

    function createit() {     // Send form data to Dweb, and display the url
        console.log("createit ---");
        // Get the data from the form
        let dict = form2dict("newform");
        <!--CommonList(data, master, key, verbose, options)-->
        let obj = new Dweb.CommonList(dict, true, {keygen: true}, verbose, {_allowunsafestore: true} );
        // _allowunsafestore is set to true since AccessControlList not set yet, so storing unencrypted.
        console.log("Created=",obj);
        obj.p_store(verbose)
            // Now re fetch it from Dweb and display the object
            .then(() => fetchanddisplay(obj._url))
            .catch((err) => { console.log("ERROR:",err); alert(err.message); });
        return false; // Stop form submission and page reloading reloading
    }

    function sendentry() {     // Send form data to Dweb, and display the url
        console.log("sendit ---");
        // Get the data from the form
        let dict = form2dict("entryform");
        // Create a new object and add to the list
        let obj = new Dweb.SmartDict(dict, verbose );
        cl.p_push(obj, verbose)
            .then(() => console.log("Added:",obj))                            // Show on the Javascript console
            .then(() => objbrowser(cl, cl._url, null, "ObjBrowser", false))   // Redisplay in objbrowser just for debugging
            .then(() => addtemplatedchild("listresults", obj))                // Display locally as listmonitor will not pick up local entries
            .catch((err) => { console.log("ERROR:",err); alert(err.message); });
        return false; // Stop form submission and page reloading reloading
    }


    function fetchit() {
        console.log("fetchit ---");
        // Get the string from the form, its just one element this time
        let dict = form2dict("fetchform");
        // Fetch it, and display
        fetchanddisplay(dict.url);
    }
    
    function fetchanddisplay(url) {
        /* Fetch a URL, display the meta data and a box for adding to it*/
        console.log("fetchanddisplay",url);
        try {
            Dweb.SmartDict.p_fetch(url, verbose)   // Throws TransportError immediately if url invalid //TODO-MULTI use urls plural
                .then((obj) => cl = obj) // Save it for adding to in sendentry
                .then(() => {
                    console.log("Fetched=", cl);
                    // Only display the input prompt if its a master list.
                    if (cl._master) { show("entryrow"); } else { hide("entryrow"); }
                    // Display the name and urls of the list
                    displayobj("retrievaldestn", cl);
                    deletechildren("listresults");
                    // Clear old text
                })
                // Fetch the current elements from the list if any
                .then(() => cl.p_list_then_elements(verbose))   //This adds the listmonitor as a side effect, so updated as changes
                .then((objs) => { console.log("objs=",JSON.stringify(objs)); return objs;})
                //Add the elements to the list
                .then((objs) => objs.map((obj) => addtemplatedchild("listresults", obj)))
                // Setup a EventListener so anything new added to the list us added to the display
                .then(() => cl.addEventListener("insert", (event) => {
                    if (verbose) console.log("fetchanddisplay",event);
                    let sig = event.detail;
                    sig.p_fetchdata(verbose)
                        .then((obj) => addtemplatedchild("listresults", obj))
                }))
                // Redisplay it in the object browser for debugging
                .then(() => objbrowser(cl, cl._url, null, "ObjBrowser", verbose))
                .catch((err) => { console.log("ERROR:",err); alert(err.message); });
        } catch(err) {
            console.log("ERROR:", err);
            alert(err.message); // bad url generates TransportError
        }
    }
    function displayobj(el, obj) {
        /* Display an obj, under an element in appropriately named fields */
        console.log(obj);
        replacetexts(el, obj, { _privateurl: (obj._master ? obj._url : "")});
        // Now set up links to the urls for sharing
        let publicurl = new URL(window.location.href);
        let privateurl = new URL(window.location.href);
        publicurl.search=(obj._publicurls.length ? "url="+obj._publicurls : ""); //TODO-MULTI publicurl test may not work well on multi
        document.getElementById("publiclink").href=publicurl.href;
        privateurl.search=obj._privateurl ? "url="+obj._privateurl : "";
        document.getElementById("privatelink").href=privateurl.href;
    }

    </script>

</head>
<body>

<!-- General design
    - list selection at top, enter by key, or hit New
    - - New opens out to request the name.
    - Name; private and public url of the list.
    - Text area for content of list - new entries appended at bottom
    - Area to enter if the list is writable.
-->
<div class="floatright">
    <div id="status">Starting</div>
</div>
<h1>Dweb - CommonList Example</h1>
<!-- Form to create a new List -->
<div><!-- Group with first toggling visibility of other two-->
    <span class="button" onclick="togglevis(['el1','el2'],'inline');">New</span>
    <span id="el1">
        <form style="display:inline" name="fetchform" onsubmit="fetchit(); return false;">
            <input class="propval" type="text" name="url" size="70" placeholder="ipfs:/ipfs/12ab34cd"/>
            <input class="button" type="submit" value="Fetch"/>
        </form>
        </span>
    <span id="el2" style="display:none;"><!-- will be displayed by the New button-->
        <form method="post" style="display:inline" name="newform" onsubmit="createit(); return false;">
            <input class="propval" type="text" name="name" placeholder="Name of new list" size="70"/>
            <input class="button" type="submit" value="Create"/>
        </form>
    </span>
</div>

<hr>


<!-- Object will be displayed here in fields with names that match-->
<ul class="props" id="retrievaldestn">
    <li class="prop"><span class="propname">Name:</span><span class="propval" name="name"></span></li><!--TODO-MULTI check privateurls is plural-->
    <li class="prop"><span class="propname">Private url:</span><span class="propval" name="_privateurls"></span><a id="privatelink"> <img alt="link" src="link.png"/></a></li>
    <li class="prop"><span class="propname">Public url:</span><span class="propval" name="_publicurls"></span><a id="publiclink"> <img alt="link" src="link.png"/></a></li>
</ul>

<table class="displayedblock">
    <tr><td colspan="2" id="listresults" style="min-height:200px; border: 1px black solid; background-color:#f0f0f0;"><span class='template said' name='say'></span></td></tr>
    <tr id="entryrow">
        <td style="width:3em;"><b>&gt;</b></td>
        <td>
            <form style="display:inline" name="entryform" onsubmit="sendentry(); return false;">
                <input class="propval" type="text" name="say" size="70" placeholder="Say something witty"/>
                    <input type="submit" value="Send"/>
            </form>
        </td>
    </tr>
</table>

<hr>
<div class="container">
    <h4>Object browser <span class="hoverclue">....</span></h4>
    <div class="hoveronly">
        <ul class="hoveronly" id="ObjBrowser"></ul>
    </div>
</div>

<script type="text/javascript">
    // This is the "main()", starts a transport, checks its status, and if appropriate to app opens a URL passed
    var searchparms = new URL(window.location.href).searchParams;
    var url = searchparms.get("url");
    var verbose = searchparms.get("verbose") || false;  // Anything specified for verbose is true (could truthify buy no need)
    let transportclass = Dweb["Transport"+(searchparms.get("transport") || "IPFS").toUpperCase()]; // e.g. Dweb["TransportHTTP"]
    transportclass.p_setup({}, verbose)
        .then((t) => t.p_status())
        .then((msg) => setstatus(msg))
        .then(() => {
            // Any code you want to run once online goes here.
            if(url) fetchanddisplay(url);
        })
        .catch((err) => { console.log("ERROR:",err); alert(err.message); });
</script>
</body>
</html>