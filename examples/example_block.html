<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--suppress HtmlUnknownTarget -->
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>DWEB Block example page</title>
    <link rel='stylesheet' href='example_styles.css'>
    <script src="https://unpkg.com/ipfs-iiif-db/dist/browser.js"></script><!--or browser.min.js-->
    <!--<script src="https://unpkg.com/ipfs-iiif-db@2.4.0/dist/browser.min.js"></script><!--or browser.min.js-->
    <!--<script src="cached/browser.min.js"></script><!-- cached version of ipfs/iiif so can test offline-->
    <!--<script type="text/javascript" src="/file/mb/BLAKE2.iYiNlcLOfxRU-coIq2foYgTN9V1J4DzPV2yTXqHUN2I="></script><!-- Dweb bundled via Dweb-->
    <script type="text/javascript" src="dweb_transport_ipfs_bundled.js"></script><!-- Dwebbundle via local filesystem when testing without Dweb-->
    <!--<script src='/dweb/tinymce/tinymce.min.js'></script><!-- TinyMCE -->
    <script src='http://cloud.tinymce.com/stable/tinymce.min.js'></script><!-- TinyMCE -->
    <script type="text/javascript" src="htmlutils.js"></script><!--objectbrowser functionality for debugging-->
    <script type="text/javascript">

    tinymce.init({
        selector: '#mytextarea',
        menubar: "true",
        plugins: [ "save",
            'advlist autolink lists link image charmap print preview anchor',
            'searchreplace visualblocks code fullscreen',
            'insertdatetime media table contextmenu paste code' ],
        toolbar: 'save | undo redo | insert | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image',
        save_onsavecallback: function() {
            verbose = true; // See commentary in console.log
            content = tinyMCE.get('mytextarea').getContent();
            // alert(content);
            blk = new Dweb.Block(content);
            blk.p_store(verbose)
                .then(() => {
                    el = document.getElementById("retrievalarea");
                    el.value = blk._url; // Use as default on input
                });
        }
    });

    function fetchit() {
        el = document.getElementById("retrievalarea");
        url = el.value;
        fetchanddisplay(url);
    }

    function fetchanddisplay(url) {
        verbose = true;
        console.log("Fetching url=", url);
        destn = document.getElementById("retrievaldestn");
        destn.innerHTML = ""; // Clear it first
        Dweb.Block.p_fetch(url, verbose)
            .then((blk) => {
                console.log("content=",blk.content());
                destn.innerHTML = blk.content()
            })
    }

    </script>
    <script type="text/css">
        .button { border: 1px black solid; background-color:#dddddd;  padding-bottom:0.1em; padding-top:0.1em;}
    </script>
</head>
<body>
<div id="status" class="status"></div>
<h1>Dweb - Block Example</h1>
<h4>Create something here, and when its saved its link will appear below</h4>
<form method="post">
    <textarea id="mytextarea" width="60%">Testing</textarea>
</form>

<h4>Enter a link here and it will be retrieved.</h4>
<form style="display:inline" onsubmit="fetchit(); return false;">
    <input type="text" class="propval" id="retrievalarea" placeholder="ipfs:/ipfs/12ab34cd" size="70"/>
    <input type="submit" class="button" value="Fetch"/>
</form>

<div class="displayedblock" id="retrievaldestn">retrieved data will go here</div>



<script type="text/javascript">

    /* Pull url out of URL search string.*/
    var url = new URL(window.location.href).searchParams.get("url")
    console.log("Loaded with url=", url);

    let verbose = true;
    let transportclass = Dweb.TransportIPFS;
    setstatus("IPFS Starting");
    //let transportclass = TransportHTTP    // Uncomment this to choose HTTP
    transportclass.p_setup({}, verbose)
        .then((t) => {
            setstatus(t.ipfs.isOnline() ? "IPFS Online" : "IPFS Not online");   //TODO status refactor to make common across transports
        })
    .then(() => { if(url) fetchanddisplay(url)})
    .catch((err) => { console.log("ERROR:",err); alert(err.message); });
</script>
</body>
</html>