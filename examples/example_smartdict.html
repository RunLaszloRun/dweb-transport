<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>DWEB SmartDict example</title>
    <link rel='stylesheet' href='example_styles.css'>
    <script type="text/javascript" src="dweb_transport_ipfs_bundled.js"></script><!-- Dwebbundle via local filesystem when testing without Dweb-->
    <script type="text/javascript" src="objbrowser.js"></script><!--objectbrowser functionality for debugging-->
    <script type="text/javascript" src="htmlutils.js"></script><!--objectbrowser functionality for debugging-->
    <script type="text/javascript">

    function sendit() {     // Send form data to Dweb, and display the url
        verbose = true;
        if (verbose) console.log("sendit ---");
        let dict = form2dict("myform");
        let sd = new Dweb.SmartDict(dict, verbose );
        if (verbose) console.log("SD=",sd);
        // Now display link
        sd.p_store(verbose) // Store the edited dictionary
        .then(() => document.getElementById("retrievalarea").value = sd._url); // Use url default on input
        return false;
    }

    function fetchit() {
        let el = document.getElementById("retrievalarea");
        let url = el.value;
        fetchanddisplay(url);
    }

    function fetchanddisplay(url) {
        verbose = true;
        if (verbose) console.log("Fetching url=", url);
        let destn = document.getElementById("retrievaldestn");
        destn.innerHTML = ""; // Clear it first
        Dweb.SmartDict.p_fetch(url, verbose)
            .then((sd) => {
                if (verbose) console.log("Fetched=",sd);
                destn.innerHTML = "My name is: "+sd.name;
                destn.style.color = sd.favcolor;
                return sd;
            })
            .then((sd) => objbrowser(sd, sd._url, null, "ObjBrowser", verbose))
    }


    </script>
</head>
<body>
<div class="floatright">
    <div id="status">Starting</div>
</div>
<h1>Dweb - SmartDict Example</h1>
<h4>Create something here, and when its saved its link will appear below</h4>
<form method="post" name="myform" onsubmit="sendit(); return false;">
    <ul>
    <li class="prop"><span class="propname">Name</span><input class="propval" type="text" name="name" size="150"/></li>
    <li class="prop"><span class="propname">Color</span><input class="propval" type="text" name="favcolor" size="150"/></li>
        <li><input type="submit" value="Store"/></li>
    </ul>
</form>
<h4>Enter a link here and it will be retrieved.</h4>
<form style="display:inline" onsubmit="fetchit(); return false;">
    <input type="text" class="propval" id="retrievalarea" placeholder="/ipfs/12ab34cd" size="70"/>
    <input type="submit" value="Fetch"/>
</form>
<div class="displayedblock" id="retrievaldestn">retrieved data will go here</div>

<hr>
<div class="container">
    <h4>Object browser <span class="hoverclue">....</span></h4>
    <div class="hoveronly">
        <ul class="hoveronly" id="ObjBrowser"></ul>
    </div>
</div>


<script type="text/javascript">
    // This is the "main()", starts a transport, checks its status, and if appropriate to app opens a URL passed
    var searchparms = new URL(window.location.href).searchParams;
    var url = searchparms.get("url");
    let transportclass = Dweb["Transport"+(searchparms.get("transport") || "IPFS").toUpperCase()]; // e.g. Dweb["TransportHTTP"]

    var verbose = searchparms.get("verbose") || false;  // Anything specified for verbose is true (could truthify buy no need)  //TODO-document this and Transport in Readme
    transportclass.p_setup({}, verbose)
        .then((t) => t.p_status())
        .then((msg) => setstatus(msg))
        .then(() => {
            // Any code you want to run once online goes here.
            if(url) fetchanddisplay(url);
        })
        .catch((err) => { console.log("ERROR:",err); alert(err.message); });
</script>
</body>
</html>