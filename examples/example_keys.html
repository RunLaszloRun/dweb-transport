<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>DWEB KeyChains and Access Control List example</title>
    <link rel='stylesheet' href='example_styles.css'>
    <!-- Load IIIF - can be commented if using Y, needed for IIIF due to error in browserify/iiif interaction-->
    <!--<script src="https://unpkg.com/ipfs-iiif-db/dist/browser.js"></script><!--or browser.min.js-->
    <!--<script src="https://unpkg.com/ipfs-iiif-db@2.4.0/dist/browser.min.js"></script><!--or browser.min.js-->
    <!--<script src="cached/browser.min.js"></script><!-- cached version of ipfs/iiif so can test offline-->
    <script type="text/javascript" src="dweb_transport_ipfs_bundled.js"></script><!-- Dwebbundle via local filesystem when testing without Dweb-->
    <!--<script src='/dweb/tinymce/tinymce.min.js'></script><!-- TinyMCE -->
    <!--<script src='http://cloud.tinymce.com/stable/tinymce.min.js'></script><!-- TinyMCE -->
    <!--<script src='/file/mb/BLAKE2.dfMoOqTdXvqKhoZo7HPvD5raBXfgH7chXsN2PElizs8=/tinymce.min.js'></script><!-- TinyMCE via relative URL-->
    <script type="text/javascript" src="objbrowser.js"></script><!--objectbrowser functionality for debugging-->
    <script type="text/javascript" src="htmlutils.js"></script><!--Non Dweb specific utility functions for working with HTML-->
    <script type="text/javascript">

    </script>
    <script type="text/javascript">
        function p_login_and_add_to_keychain(dict) {
            // Add to HTML list of logins
            verbose=true;
            if (verbose) console.log("p_login_and_add_to_keychain",JSON.stringify(dict));
            return Dweb.KeyChain.p_new({ name: dict.name}, {passphrase: dict.name + "/" + dict.passphrase}, verbose)
                .then((kc) => {
                    let htmleach = "<li class='vertical_li' onclick='p_kc_click(this);'><span class='kclist_name' name='name'></span></li>";
                    addhtml("kclist_ul", htmleach, kc );    // returns el, but unused
                    show('logout'); // And show the logout button
                    return kc;
                })
        }

        function p_registrationsubmit() {
            let verbose = true; //copious debugging in console log
            if (verbose) console.log("p_registrationsubmit ---");
            hide('registrationdiv');
            let dict = form2dict("registrationform"); //name, passphrase
            return p_login_and_add_to_keychain(dict)
                    .then((kc) => objbrowser(kc,null,null,'ObjBrowser',verbose))
        }

        function clicklogout() {
            // Remove from keychains
            Dweb.keychains = [];
            deletechildren("kclist_ul");   // Delete any visible ones
            if (Dweb.keychains.length === 0) hide('logout'); // Nothing to logout
        }

        function p_loginformsubmit() {
            // At the moment this is identical behavior to p_registrationsubmit, but that could change
            let verbose = true; //copious debugging in console log
            if (verbose) console.log("loginformsubmit ---");
            let dict = form2dict("loginform"); //name, passphrase
            hide('logindiv');
            return p_login_and_add_to_keychain(dict)
                .then((kc) => objbrowser(kc,null,null,'ObjBrowser',verbose))
        }

        const objsyms = {acl: "noun_1093404_cc.png", kp: "noun_1146472_cc.png"}; /* If change here - see also Keys on KeyChain code below*/
        function _kclist_push(obj) {
            // Utility function to add new or existing element to Key List
            let objtype = obj.table; // acl = AccessControlList, kp = KeyPair
            let objsym = objsyms[objtype];
            let objclick = {acl: 'p_acl_click(this);', kp: 'p_key_click(this);'}[objtype];
            let htmleach = '<li class="inline_li" onclick="'+objclick+'"><img class="keylist_icon" src="'+objsym+'"/><span class="keylist_name" name="name"></span></li>';
            return addhtml("keylist_ul", htmleach, obj);
        }
        function p_kc_click(el) {
            let kc = el.source;
            show('keys'); //block - Show keylist
            let el_keylistheader = replacetexts("keylist_header", kc);    // Set name fields etc in keylistdiv, sets source
            deletechildren("keylist_ul");
            return kc.p_list_then_elements()                            // Retrieve the keys for the keylist
                .then(() => kc._keys.map((key)=> _kclist_push(key)))    // And add to the HTML
        		.then(() => kc.listmonitor(                             // Note the callback will store on kc as well before calling this function
                    (sig) => {
                        if (sig.signedby === el_keylistheader.source._publicurl)
                            sig.p_fetchdata(verbose)                   // and will ignore duplicates including an echo of the one we add
                                .then((obj) => _kclist_push(obj)) },
                    verbose));
        }
        function p_newkey() {
            let verbose = true; //copious debugging in console log
            if (verbose) console.log("p_newkey ---");
            hide('keynew_div');
            let dict = form2dict("newkeyform"); //name
            let kc = document.getElementById('keylist_header').source;
            let key = new Dweb.KeyPair({name: dict.name, key: {keygen: true}, _acl: kc}, verbose );
            _kclist_push(key);   // Dont put in UI, as listmonitor gets it as well.
            return key.p_store(verbose)
                .then(() => kc.p_push(key, verbose));
        }
        function p_newtoken() { //Called by "Add" button on new token dialog
            let verbose = true; //copious debugging in console log
            if (verbose) console.log("p_newtoken ---");
            hide('tokennew_div');
            let dict = form2dict("newtokenform"); //url
            acl = document.getElementById('acl_header').source;
            return acl.p_add_acle(dict.url, {name: dict["name"]}, verbose)
                .then((tok) => acllist_push(tok)) // Push to visual list, as listmonitor will be a duplicate
        }
        function p_newacl() {
            let verbose = true; //copious debugging in console log
            if (verbose) console.log("p_newacl ---");
            hide('aclnew_div');
            let dict = form2dict("newaclform"); //name
            let kc = document.getElementById('keylist_header').source;  // The KeyChain being added to.
            return Dweb.AccessControlList.p_new({name: dict.name, _acl: kc}, true, {keygen: true}, verbose, null, kc )    //(data, master, key, verbose, options, kc)
                .then((acl) => _kclist_push(acl)); // Dont put in UI, as listmonitor gets it as well.
        }
        function p_key_click(el) {
            let verbose = false; //copious debugging in console log
            if (verbose) console.log("p_key_click ---");
            source = el.source;
            window.prompt("Copy to clipboard (Ctrl-C + OK)", el.source._publicurl);
        }
        function acllist_push(obj) {
            // Add an key to list showing an ACL, clicking on it will display key's public key (just as for a KeyChain).
            let htmleach = `<li class="inline_li" onclick="p_key_click(this)"><img class="keylist_icon" src="${objsyms['kp']}"/><span class="keylist_name" name="name"></span></li>`;
            return addhtml("acl_ul", htmleach, obj);    // returns element
        }
        function p_acl_click(el) {
            let verbose = false;
            if (verbose) console.log("p_acl_click ---");
            let acl = el.source;                                    // The ACL clicked on
            show('tokens_div');                                     // Show the HTML with a list of tokens in ACL
            let el_aclheader = replacetexts("acl_header", acl);     // Set name fields etc in keylistdiv, sets source
            deletechildren("acl_ul");                               // Remove any existing HTML children
            return acl.p_tokens()                                       // Retrieve the keys for the keylist
                .then((toks) => toks.map((tok) => acllist_push(tok)))   // And add to the HTML
                .then(() => acl.listmonitor(                            // Note the callback should store on acl as well before calling this function
                    (sig) => {
                        if (sig.signedby === el_aclheader.source._publicurl) {
                            sig.p_fetchdata(verbose)
                                .then((tok) => acllist_push(tok))
                        }},
                    verbose));
        }

    </script>
</head>
<body>
    <div class="floatright">
        <div id="status">Starting</div>
        <ul id="kclist_ul"><!-- List of all existing keychains--></ul>
        <form><input id="logout" class="button" type="button" onclick="clicklogout();" style="display:none;" value="Logout"/></form><!--logout all keychains-->
        <img src="noun_186903_cc.png" alt="keychain" class="iconopener" onclick="togglevis('logindiv','');"/>
    </div>
    <h1>Dweb - KeyChains and Access Control List Example</h1>
    <!-- General design
    Key Chains icon - opens / closes to
        List of Key Chains - names - click -> Key Chain management opens
        Passphrase & Login button - fill and login -> retrieved and listed above
        Register button -> click -> registration dialogue
    Registration dialogue [x]
        Name of KeyChain/Login, Pass Phrase
        Submit -> create KeyChain, add to KeyChains,
    Key Chain Management screen [x]
        Name of chain at top
        List of items in chain: Name; publickey; some links -> TODO -> copy publickey
            TODO - add ACL's to keychains and display here - open to ACL screen
        New Key button -> New Key Form
        New ACL button -> TBD
    New Key Form:
        Name,
        Generate button -> Generate key, add to KeyChain
    ACL screen [x]
        List of keys in ACL
        Way to add new Key based on string
        Need way to add this key to smartdict or list
    //TODO - need some example of using them
    -->
    <div id="logindiv" style="position:relative; left:25px; display:none;"><!-- needs position:relative, so parent for overdiv below-->
        <div class="displayedblock"><!--inline next to keychain-->
            <form class="dialogform" name="loginform" onsubmit="p_loginformsubmit(); return false;"><!--TODO-->
                <input class="propval" type="text" name="name" size="20" placeholder="Your id"/>
                <input class="propval" type="text" name="passphrase" size="70" placeholder="Passphrase"/>
                <input class="button" type="submit" value="Login"/>
                <input class="button" type="button" onclick="togglevis('registrationdiv','block');" value="Register"/>
            </form>
        </div>
        <div id="registrationdiv" class="overdiv" style="display:none">
            <form class="dialogform" name="registrationform" onsubmit="p_registrationsubmit(); return false;">
                <input class="propval" type="text" name="name" size="50" placeholder="Your id - it doesnt have to be unique"/>
                <input class="propval" type="text" name="passphrase" size="70" placeholder="Type a complex phrase, easy for you to remember, hard for others to guess, mixed case, numbers, punctuation are all good"/>
                <input class="button" type="submit" value="Register"/>
            </form>
        </div>

    </div>


    <div id="keys" style="position:relative; display:none;"><!-- needs position:relative, so parent for overdiv below-->
        <div id="keynew_div" class="overdiv" style="display:none">
            <form name="newkeyform" onsubmit="p_newkey(); return false;">
                <input class="propval" type="text" name="name" size="50" placeholder="Name of the key"/>
                <input class="button" type="submit" value="Generate"/>
            </form>
        </div>
        <div id="aclnew_div" class="overdiv" style="display:none">
            <form name="newaclform" onsubmit="p_newacl(); return false;">
                <input class="propval" type="text" name="name" size="50" placeholder="Name of the ACL"/>
                <input class="button" type="submit" value="Generate"/>
            </form>
        </div>
        <div id="keylist_div" class="displayedblock">
            <div class="displayedblockheader" id="keylist_header">
                <form class="dialogform">
                    Keys on KeyChain:
                    <span name="name"></span>
                    <!--If change icons, see objsyms above-->
                    <img class="keylist_icon" src="noun_1146472_cc.png" alt="Key"/><input class="button" type="button" onclick="show('keynew_div');" value="new key"/>
                    <img class="keylist_icon" src="noun_1093404_cc.png" alt="Lock"/><input class="button" type="button" onclick="show('aclnew_div');" value="new lock"/>
                    <input class="button" type="button" onclick="hide('keys');" value="x"/><!--TODO replace with close icon-->
                </form>
            </div>
            <ul id="keylist_ul" class="inline_ul"><!-- List of all keys in keychain--></ul>
        </div>
        <!--ACL display -->
    </div>
    <div id="acl" style="position:relative;"><!-- needs position:relative, so parent for overdiv below-->
        <div id="tokens_div" class="displayedblock" style="display:none">
            <div class="displayedblockheader" id="acl_header">
                Keys valid in lock: <span name="name"></span>

                <form class="dialogform">
                    <img class="keylist_icon" src="noun_1146472_cc.png" alt="Key"/><input class="button" type="button" onclick="show('tokennew_div');" value="new key"/>
                    <input class="button" type="button" onclick="hide('keys');" value="x"/><!--TODO replace with close icon-->
                </form>
            </div>
            <ul id="acl_ul" class="inline_ul"><!-- List of all tokens in AccessControlList--></ul>
        </div>
        <!--Dialogue to enter a new key for an ACL --><!--TODO-REL4 add a name to token-->
        <div id="tokennew_div" class="overdiv" style="display:none">
            <form name="newtokenform" onsubmit="p_newtoken(); return false;">
                <input class="propval" type="text" name="name" size="20" placeholder="Name of key"/>
                <input class="propval" type="text" name="url" size="50" placeholder="URL of key"/>
                <input class="button" type="submit" value="Add"/>
            </form>
        </div>


    </div>

    <hr><!-- Object Browser gives a way to look at the data structures being displayed -->

    <div class="container">
    <h4>Object browser <span class="hoverclue">....</span></h4>
    <div class="hoveronly">
    <ul class="hoveronly" id="ObjBrowser"></ul>
    </div>
    </div>

    <script type="text/javascript">
        // This is the "main()", starts a transport, checks its status, and if appropriate to app opens a URL passed
        const searchparms = new URL(window.location.href).searchParams;
        const url = searchparms.get("url");
        let transportclass = Dweb["Transport"+(searchparms.get("transport") || "IPFS").toUpperCase()]; // e.g. Dweb["TransportHTTP"]

        let verbose = false;
        transportclass.p_setup({}, verbose)
            .then((t) => t.p_status())
            .then((msg) => setstatus(msg))
            .then(() => {
                // Any code you want to run once online goes here.
                //if(url) fetchanddisplay(url);  // In this app, ignoring any URL passed in call
            })
            .catch((err) => { console.log("ERROR:",err); alert(err.message); });
    </script>
</body>
</html>


